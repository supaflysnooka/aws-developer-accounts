# environments/dev-accounts/main.tf
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
  
  backend "s3" {
    bucket         = "boseprofessional-org-terraform-state"
    key            = "dev-accounts/terraform.tfstate"
    region         = "us-west-2"
    dynamodb_table = "boseprofessional-org-terraform-locks"
    encrypt        = true
   # profile        = "AdministratorAccess-816648956019"
  }
}

# Single provider - management account
provider "aws" {
  region = var.aws_region
}

# Get current account ID
data "aws_caller_identity" "current" {}

# Define all developers
locals {
  developers = {
    "john-smith" = {
      email          = "john.smith@boseprofessional.com"
      budget_limit   = 100
      jira_ticket_id = "INFRA-123"
    }
    "jane-doe" = {
      email          = "jane.doe@boseprofessional.com"
      budget_limit   = 150
      jira_ticket_id = "INFRA-124"
    }
  }
}

# Create all developer accounts
module "developer_accounts" {
  for_each = local.developers
  source   = "../../modules/account-factory"
  
  developer_name        = each.key
  developer_email       = each.value.email
  budget_limit          = each.value.budget_limit
  jira_ticket_id        = each.value.jira_ticket_id
  management_account_id = data.aws_caller_identity.current.account_id
  aws_region            = var.aws_region
}

# Variables
variable "aws_region" {
  description = "Primary AWS region"
  type        = string
  default     = "us-west-2"
}

# Outputs
output "developer_accounts" {
  description = "Summary of created developer accounts"
  value = {
    for name, account in module.developer_accounts : name => {
      account_id     = account.account_id
      account_email  = account.account_email
      state_bucket   = account.terraform_state_bucket
      lock_table     = account.terraform_lock_table
      role_arn       = account.developer_role_arn
      onboarding_doc = account.onboarding_doc_path
    }
  }
}
